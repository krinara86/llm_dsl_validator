# LLM to DSL translation

<<<<<<< HEAD
We use a custom-built Domain-Specific Language (DSL) and interpreter to enforce business logic on the output of a Large Language Model (LLM).
=======
This project demonstrates a system that uses a custom DSL and interpreter to enforce business logic on the output of a Large Language Model (LLM).
>>>>>>> 946afb3270542b4ed7bfa9a4bad766cdf5f258ec


## Setup

<<<<<<< HEAD
1.  **Translation:** An LLM (Ollama's Llama 3) takes a conversational, unstructured user query and translates it into a formal, structured representation using our custom-built DSLs.
2.  **Interpretation:** A custom interpreter, written in Python using the Lark parsing library, executes the DSL code. This interpreter contains the business logic.
=======
System comprises of two parts:

1.  **Translation:** An LLM (Ollama's Llama 3) takes a conversational, unstructured user query and translates it into a formal, structured representation using a DSL built on top of [Lark](https://github.com/lark-parser/lark) .
2.  **Interpretation:** A custom interpreter, written in Python using Lark's parsing library, executes the DSL code. 

>>>>>>> 946afb3270542b4ed7bfa9a4bad766cdf5f258ec

---

## How to run

### 1. Prerequisites: Install Ollama

This demo requires a Ollama server. You can run this locally

1.  **Install Ollama:** Download from <https://ollama.com>.
2.  **Download the Model:** Open a terminal and run:
    ```bash
    ollama pull llama3:8b
    ```

### 2. Setup the Python Environment

The demo is a Jupyter Notebook so it requires a python environment (If you donot have python, please install it)

1.  **Navigate to the Project Folder:**
    ```bash
    cd llm_dsl_validator
    ```
2.  **Create and Activate a Virtual Environment:**
    ```bash
    python -m venv venv
    .\venv\Scripts\Activate.ps1
    ```
    *(Note: On PowerShell, you may first need to run `Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process`)*

3.  **Install Dependencies:**
    ```bash
    pip install -r requirements.txt
    ```

### 3. Launch the Notebook

1.  **Start the Jupyter Server:**
    ```bash
    jupyter notebook
    ```
2.  **Run the Demo:** Open `notebooks/demo.ipynb` in your browser and execute the cells in order.

---

## Implementation Details

<<<<<<< HEAD
The project now supports two distinct domains, each with its own DSL, interpreter, and prompt.

### The Custom DSLs

The system uses two simple, text-based DSLs. The formal grammars are defined in `.dsl` files using the Lark syntax.

**1. Tax Calculation Grammar (`tax_rules.dsl`):**
=======
### Restaurant bill DSL 

Bills have the syntax `bill` followed `items` each of which have a name followed by the quantity of the item and the price or just the price if there is only one of the said item. 
>>>>>>> 946afb3270542b4ed7bfa9a4bad766cdf5f258ec

start: bill
bill: "bill" "{" items "}"
items: item+
item: CNAME ":" NUMBER "*" NUMBER -> line_item_with_quantity
| CNAME ":" NUMBER           -> line_item_simple

%import common.CNAME
%import common.NUMBER
%import common.WS
%ignore WS

*Example DSL Code (Generated by LLM):*

bill {
burger: 2 * 10
soda: 3
}

<<<<<<< HEAD

**2. Cycling Planner Grammar (`cycling_planner.dsl`):**
// Grammar for Cycling Ride Planner DSL
start: ride
ride: "ride" "{" properties "}"
properties: property+
property: CNAME ":" (CNAME | NUMBER) -> prop_line
=======
### Interpreter

The interpreter (`src/interpreter.py`) implements the Lark `Transformer`. 
>>>>>>> 946afb3270542b4ed7bfa9a4bad766cdf5f258ec

%import common.CNAME
%import common.NUMBER
%import common.WS
%ignore WS

<<<<<<< HEAD
=======
This interpreter acts as a "source of truth" for all calculations.
>>>>>>> 946afb3270542b4ed7bfa9a4bad766cdf5f258ec

*Example DSL Code (Generated by LLM):*
ride {
terrain: hilly
distance_km: 50
}

<<<<<<< HEAD
### Interpreters

The interpreters, located in `src/interpreters/`, are Python classes that implement the Lark `Transformer` interface. They walk the parse tree generated by Lark and execute business logic.

* **`BillInterpreter`** (`tax_interpreter.py`): This interpreter processes a restaurant bill. It categorizes items into "food" or "drink" based on hardcoded keywords and applies fixed tax rates (7% for food, 19% for drink) to calculate the final total.
* **`RideInterpreter`** (`cycling_interpreter.py`): This interpreter processes a bike ride plan. It calculates an estimated ride duration based on the provided `distance_km` and `terrain` (flat, hilly, or mountainous), using a hardcoded set of average speeds for each terrain type.

### The LLM Prompts

The core logic in `src/core.py` uses carefully engineered prompts to instruct the LLM to act as a translator for each domain.

**1. Tax Calculation Prompt:**
=======
>>>>>>> 946afb3270542b4ed7bfa9a4bad766cdf5f258ec
```python
prompt = """You are a helpful assistant that translates natural language into a custom DSL.
The DSL format is:
bill {{
  itemName: quantity * pricePerItem
  anotherItemName: price
}}
Translate the following user order into this DSL. The item names should be simple, lowercase words like 'burger' or 'soda'.
User Order: "{user_query}"
DSL Response:"""

<<<<<<< HEAD
prompt = """You are a helpful assistant that translates natural language into a custom DSL for planning a bike ride.
The DSL format is:
ride {{
  terrain: flat | hilly | mountainous
  distance_km: number
}}
Translate the following user request into this DSL. The 'terrain' value must be an unquoted word.
User Request: "{user_query}"
DSL Response:"""
=======
DSL Response:
"""
```

---

## Next Steps

### 1. Deploy as a service

The current model requires each user to run a local Ollama server. As part of this task, we will host the core components on a central server. 
Note: Part of this would involve exposing the logic in src/core.py as an API endpoint using some web framework like Flask or FastAPI. 

### 2. Expand the DSL and Interpreter

The `tax_rules.dsl` grammar can be updated to include new concepts, such as discounts, tips, or different item categories.

### 3. Incorporate other example DSLs

Consider other examples DSLs from other domains (finance, cycling?)

### 3. Build a Dedicated Web Frontend

Build a frontend (React, Vue?). Jupyter Notebooks are easy to work with, but not for demos. 
>>>>>>> 946afb3270542b4ed7bfa9a4bad766cdf5f258ec
